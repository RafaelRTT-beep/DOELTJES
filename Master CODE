#include <WiFi.h>
#include <ESPAsyncWebServer.h>
#include <WebSocketsServer.h>
#include <esp_now.h>
#include <ArduinoJson.h>

// Systeem variabelen
AsyncWebServer server(80);
WebSocketsServer webSocket = WebSocketsServer(81);
unsigned long startTime = 0;
bool active = false;
int hits = 0;

// Structuur voor snelle data-overdracht
typedef struct struct_message {
    int targetID;
    float impactForce;
} struct_message;

struct_message incomingReadings;

// De ultrasnelle ontvangst-handler
#if ESP_ARDUINO_VERSION >= ESP_ARDUINO_VERSION_VAL(3, 0, 0)
void onDataRecv(const esp_now_recv_info *info, const uint8_t *data, int len) {
#else
void onDataRecv(const uint8_t *mac, const uint8_t *data, int len) {
#endif
    memcpy(&incomingReadings, data, sizeof(incomingReadings));
    
    hits++;
    long reactionTime = millis() - startTime;
    
    // Directe broadcast naar TV/Telefoon (JSON formaat)
    StaticJsonDocument<200> doc;
    doc["type"] = "HIT";
    doc["id"] = incomingReadings.targetID;
    doc["total"] = hits;
    doc["time"] = reactionTime / 1000.0;
    
    String output;
    serializeJson(doc, output);
    webSocket.broadcastTXT(output);
}

void setup() {
    Serial.begin(115200);
    WiFi.softAP("STEALTH_TARGET_PRO", "AlphaOne", 1, 0, 4); // Max 4 verbindingen voor stabiliteit
    
    if (esp_now_init() == ESP_OK) {
        esp_now_register_recv_cb(onDataRecv);
    }

    // De Web Interface (Tactisch Black-Ops Design)
    server.on("/", HTTP_GET, [](AsyncWebServerRequest *request){
        request->send(200, "text/html", "INDEX_HTML_CONTENT"); 
    });

    server.begin();
    webSocket.begin();
}

void loop() {
    webSocket.loop();
}

#include <WiFi.h>
#include <ESPAsyncWebServer.h>
#include <WebSocketsServer.h>
#include <esp_now.h>
#include <ArduinoJson.h>

const char* ssid = "STEALTH_TARGET_PRO";
const char* password = "rtt";

AsyncWebServer server(80);
WebSocketsServer webSocket = WebSocketsServer(81);

int totalScore = 0;
bool gameActive = false;
unsigned long startTime = 0;

typedef struct struct_message {
    int targetID;
    float impactForce;
} struct_message;
struct_message incomingHit;

// --- TACTISCHE HUD INTERFACE ---
const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TTS HUD</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        body { background: #050505; color: #fff; font-family: 'Orbitron', sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; border: 4px solid #1a0000; box-sizing: border-box; }
        header { padding: 15px; background: linear-gradient(90deg, #300 0%, transparent 100%); border-bottom: 2px solid #f00; display: flex; justify-content: space-between; align-items: center; }
        main { display: grid; grid-template-columns: 2fr 1fr; flex-grow: 1; padding: 20px; gap: 20px; }
        .display-unit { display: flex; flex-direction: column; justify-content: center; align-items: center; border-right: 1px solid #300; }
        #score { font-size: 15vw; font-weight: 900; color: #f00; text-shadow: 0 0 30px #f00; margin: 0; }
        .timer-unit { font-size: 4vw; color: #888; }
        .side-panel { display: flex; flex-direction: column; gap: 15px; }
        .control-box { background: rgba(20,20,20,0.9); border-left: 5px solid #f00; padding: 15px; }
        button { background: transparent; border: 1px solid #444; color: #fff; padding: 12px; font-family: 'Orbitron'; cursor: pointer; text-transform: uppercase; width: 100%; margin-bottom: 5px; }
        button:hover { background: #f00; color: #000; }
        #log { flex-grow: 1; background: #000; border: 1px solid #222; padding: 10px; font-family: monospace; color: #0f0; font-size: 0.7em; overflow: hidden; }
        .flash { animation: f 0.1s ease-out; }
        @keyframes f { 0% { background: #400; } 100% { background: #050505; } }
    </style>
</head>
<body id="b">
<header><div>TTS // COMMANDER</div><div id="stat">STATUS: READY</div></header>
<main>
    <div class="display-unit">
        <div id="score">00</div>
        <div class="timer-unit">CLOCK: <span id="timer">00.0</span>s</div>
    </div>
    <div class="side-panel">
        <div class="control-box">
            <button onclick="send('START')">ENGAGE MISSION</button>
            <button onclick="send('RESET')">RELOAD SYSTEM</button>
        </div>
        <div class="control-box">
            <h3>SENSITIVITY: <span id="sVal">500</span></h3>
            <input type="range" min="100" max="3000" value="500" style="width:100%; accent-color:#f00;" oninput="sendSens(this.value)">
        </div>
        <div id="log">> STANDBY...</div>
    </div>
</main>
<script>
    var ws = new WebSocket('ws://' + window.location.hostname + ':81/');
    var timerInt; var time = 0;
    ws.onmessage = function(e) {
        var d = JSON.parse(e.data);
        if(d.type === "HIT") {
            document.getElementById('score').innerText = d.total.toString().padStart(2, '0');
            document.getElementById('b').classList.add('flash');
            setTimeout(()=>document.getElementById('b').classList.remove('flash'), 100);
            document.getElementById('log').innerHTML = "> TARGET " + d.id + " HIT [" + d.time + "s]<br>" + document.getElementById('log').innerHTML;
        }
    };
    function send(m) { 
        ws.send(m);
        if(m==='START'){ time=0; clearInterval(timerInt); timerInt=setInterval(()=>{time+=0.1; document.getElementById('timer').innerText=time.toFixed(1);},100); }
        else { clearInterval(timerInt); document.getElementById('timer').innerText="0.0"; }
    }
    function sendSens(v) { document.getElementById('sVal').innerText=v; ws.send("SENS:"+v); }
</script>
</body>
</html>
)rawliteral";

#if ESP_ARDUINO_VERSION >= ESP_ARDUINO_VERSION_VAL(3, 0, 0)
void onDataRecv(const esp_now_recv_info *info, const uint8_t *incomingData, int len) {
#else
void onDataRecv(const uint8_t *mac, const uint8_t *incomingData, int len) {
#endif
    if (len == sizeof(struct_message)) {
        memcpy(&incomingHit, incomingData, sizeof(incomingHit));
        if (gameActive) {
            totalScore++;
            float react = (millis() - startTime) / 1000.0;
            String json = "{\"type\":\"HIT\",\"total\":" + String(totalScore) + ",\"id\":" + String(incomingHit.targetID) + ",\"time\":" + String(react) + "}";
            webSocket.broadcastTXT(json);
        }
    }
}

void onWebSocketEvent(uint8_t num, WStype_t type, uint8_t * payload, size_t length) {
    if (type == WStype_TEXT) {
        String msg = (char*)payload;
        if (msg == "START") { gameActive = true; startTime = millis(); totalScore = 0; }
        else if (msg == "RESET") { gameActive = false; totalScore = 0; }
        else if (msg.startsWith("SENS:")) {
            int s = msg.substring(5).toInt();
            uint8_t bcast[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};
            esp_now_send(bcast, (uint8_t *) &s, sizeof(s));
        }
    }
}

void setup() {
    Serial.begin(115200);
    WiFi.softAP(ssid, password);
    if (esp_now_init() != ESP_OK) return;
    esp_now_register_recv_cb(onDataRecv);
    server.on("/", HTTP_GET, [](AsyncWebServerRequest *request){ request->send(200, "text/html", index_html); });
    server.begin();
    webSocket.begin();
    webSocket.onEvent(onWebSocketEvent);
    Serial.print("Master MAC: "); Serial.println(WiFi.macAddress());
}

void loop() { webSocket.loop(); }

#include <WiFi.h>
#include <ESPAsyncWebServer.h>
#include <WebSocketsServer.h>
#include <esp_now.h>
#include <ArduinoJson.h>
#include <nvs_flash.h>

// --- CONFIGURATIE ---
const char* ssid = "RTT_TARGET_ELITE";
const char* password = "1234567"; 

AsyncWebServer server(80);
WebSocketsServer webSocket = WebSocketsServer(81);

uint8_t slave1Addr[] = {0x28, 0x05, 0xA5, 0x07, 0x5D, 0x88}; 
uint8_t slave2Addr[] = {0xB0, 0xCB, 0xD8, 0xE9, 0xE9, 0x50};

enum GameMode { MANUAL, SEQUENCE, RANDOM };
GameMode currentMode = MANUAL;

int totalScore = 0;
int nextTargetNeeded = 0; 
bool gameActive = false, gamePaused = false;
unsigned long lastTargetTime = 0;
int randomWaitTime = 0;

typedef struct struct_message { int targetID; int command; } struct_message;
struct_message rxData, txData;

void signalSlave(int id, int state) {
    txData.targetID = id; txData.command = state;
    if (id == 1) esp_now_send(slave1Addr, (uint8_t *) &txData, sizeof(txData));
    if (id == 2) esp_now_send(slave2Addr, (uint8_t *) &txData, sizeof(txData));
}

// --- WEB INTERFACE ---
const char index_html[] PROGMEM = R"rawliteral(<!DOCTYPE html><html><head><meta charset="UTF-8"><style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
:root{--r:#F00;--w:#FFF;--b:#050505;}
body{background:var(--b);color:var(--w);font-family:'Orbitron',sans-serif;margin:0;display:grid;grid-template-columns:320px 1fr;height:100vh;overflow:hidden;}
.side{background:#111;border-right:4px solid var(--r);padding:25px;display:flex;flex-direction:column;gap:15px;}
.btn-m{background:#000;border:2px solid #333;color:#666;padding:22px;font-size:1.1em;cursor:pointer;font-family:'Orbitron';text-transform:uppercase;}
.btn-m.active{border-color:var(--w);color:var(--w);background:var(--r);box-shadow:0 0 15px rgba(255,0,0,0.4);}
.main{display:flex;flex-direction:column;justify-content:center;align-items:center;background:radial-gradient(circle,#151515,#000);}
#score{font-size:22vw;font-weight:900;color:var(--r);line-height:0.9;margin:0;text-shadow:0 0 40px rgba(255,0,0,0.3);}
.acts{display:flex;gap:20px;width:85%;margin-top:40px;}
.btn-a{flex:1;padding:30px;font-size:1.6em;font-weight:900;cursor:pointer;font-family:'Orbitron';text-transform:uppercase;border:none;}
#sBtn{background:var(--w);color:var(--b);}
#rBtn{background:transparent;border:3px solid var(--r);color:var(--r);}
.flash{animation:f 0.1s;}@keyframes f{0%{background:#500;}100%{background:#050505;}}</style></head><body id="b">
<div class="side"><h2 style="color:var(--r);letter-spacing:2px;">MODES</h2>
<button class="btn-m active" id="m0" onclick="setM(0)">Free Fire</button>
<button class="btn-m" id="m1" onclick="setM(1)">Sequence</button>
<button class="btn-m" id="m2" onclick="setM(2)">Random</button></div>
<div class="main"><div id="score">00</div><div id="tm" style="font-size:5vw;opacity:0.5;letter-spacing:5px;">00.00</div>
<div class="acts"><button id="rBtn" class="btn-a" onclick="reset()">Reset</button><button id="sBtn" class="btn-a" onclick="start()">Start</button></div></div>
<script>
var ws=new WebSocket('ws://'+window.location.hostname+':81/'),t,time=0,run=false;
ws.onmessage=function(e){var d=JSON.parse(e.data);if(d.type==="HIT"){document.getElementById('score').innerText=d.total.toString().padStart(2,'0');
document.getElementById('b').classList.add('flash');setTimeout(()=>document.getElementById('b').classList.remove('flash'),100);}};
function setM(m){ws.send("MODE:"+m);document.querySelectorAll('.btn-m').forEach(b=>b.classList.remove('active'));document.getElementById('m'+m).classList.add('active');}
function start(){if(!run){ws.send("START");document.getElementById('sBtn').innerText="Pause";t=setInterval(()=>{time+=0.01;document.getElementById('tm').innerText=time.toFixed(2);},10);run=true;}
else{ws.send("PAUSE");document.getElementById('sBtn').innerText="Resume";clearInterval(t);run=false;}}
function reset(){ws.send("RESET");clearInterval(t);time=0;run=false;document.getElementById('score').innerText="00";document.getElementById('tm').innerText="00.00";document.getElementById('sBtn').innerText="Start";}
</script></body></html>)rawliteral";

// --- LOGICA ---
#if ESP_ARDUINO_VERSION >= ESP_ARDUINO_VERSION_VAL(3, 0, 0)
void onDataRecv(const esp_now_recv_info *info, const uint8_t *data, int len) {
#else
void onDataRecv(const uint8_t *mac, const uint8_t *data, int len) {
#endif
    if (!gameActive || gamePaused) return;
    memcpy(&rxData, data, sizeof(rxData));
    bool hitValid = (currentMode == MANUAL) || (rxData.targetID == nextTargetNeeded);
    if (hitValid) {
        totalScore++;
        webSocket.broadcastTXT("{\"type\":\"HIT\",\"total\":" + String(totalScore) + ",\"id\":" + String(rxData.targetID) + "}");
        if (currentMode == SEQUENCE) nextTargetNeeded = (nextTargetNeeded == 1) ? 2 : 1;
        else if (currentMode == RANDOM) { signalSlave(nextTargetNeeded, 0); nextTargetNeeded = 0; lastTargetTime = millis(); randomWaitTime = random(1000, 15000); }
    }
}

void setup() {
    Serial.begin(115200); nvs_flash_erase(); nvs_flash_init();
    WiFi.mode(WIFI_AP_STA); WiFi.softAP(ssid, password);
    if (esp_now_init() == ESP_OK) {
        esp_now_register_recv_cb(esp_now_recv_cb_t(onDataRecv));
        esp_now_peer_info_t p={}; p.channel=0; p.encrypt=false;
        memcpy(p.peer_addr, slave1Addr, 6); esp_now_add_peer(&p);
        memcpy(p.peer_addr, slave2Addr, 6); esp_now_add_peer(&p);
    }
    server.on("/", HTTP_GET, [](AsyncWebServerRequest *r){ r->send(200, "text/html", index_html); });
    server.begin(); webSocket.begin();
    webSocket.onEvent([](uint8_t n, WStype_t type, uint8_t * p, size_t l){
        if (type == WStype_TEXT) {
            String msg = (char*)p;
            if (msg == "START") { gameActive = true; gamePaused = false; totalScore = 0; if(currentMode == RANDOM) { lastTargetTime = millis(); randomWaitTime = 2000; nextTargetNeeded = 0; } else nextTargetNeeded = 1; }
            else if (msg == "PAUSE") gamePaused = !gamePaused;
            else if (msg == "RESET") { gameActive = false; totalScore = 0; }
            else if (msg.startsWith("MODE:")) currentMode = (GameMode)msg.substring(5).toInt();
        }
    });
}

void loop() {
    webSocket.loop();
    if (gameActive && !gamePaused && currentMode == RANDOM && nextTargetNeeded == 0) {
        if (millis() - lastTargetTime >= (unsigned long)randomWaitTime) {
            nextTargetNeeded = random(1, 3);
            signalSlave(nextTargetNeeded, 1);
        }
    }
}

#include <WiFi.h>
#include <ESPAsyncWebServer.h>
#include <WebSocketsServer.h>
#include <esp_now.h>
#include <ArduinoJson.h>

// --- CONFIGURATIE ---
const char* ssid = "RTT TARGET PRO";
const char* password = "waalhaven187"; 

AsyncWebServer server(80);
WebSocketsServer webSocket = WebSocketsServer(81);

int totalScore = 0;
bool gameActive = false;
unsigned long startTime = 0;

typedef struct struct_message {
    int targetID;
    float impactForce;
} struct_message;
struct_message incomingHit;

// De HTML interface (vereenvoudigd voor deze herstel-stap)
const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE html><html><head><title>TTS HUD</title>
<style>body{background:#000;color:red;font-family:sans-serif;text-align:center;}
#score{font-size:100px;}</style></head>
<body><h1>TARGET MASTER</h1><div id="score">00</div>
<button onclick="ws.send('START')">START</button>
<script>var ws=new WebSocket('ws://'+window.location.hostname+':81/');
ws.onmessage=function(e){var d=JSON.parse(e.data);if(d.type==='HIT')
document.getElementById('score').innerText=d.total;};</script>
</body></html>)rawliteral";

// Callback als er een hit binnenkomt
#if ESP_ARDUINO_VERSION >= ESP_ARDUINO_VERSION_VAL(3, 0, 0)
void onDataRecv(const esp_now_recv_info *info, const uint8_t *incomingData, int len) {
#else
void onDataRecv(const uint8_t *mac, const uint8_t *incomingData, int len) {
#endif
    memcpy(&incomingHit, incomingData, sizeof(incomingHit));
    if (gameActive) {
        totalScore++;
        String json = "{\"type\":\"HIT\",\"total\":" + String(totalScore) + "}";
        webSocket.broadcastTXT(json);
    }
}

void onWebSocketEvent(uint8_t num, WStype_t type, uint8_t * payload, size_t length) {
    if (type == WStype_TEXT) {
        if (strcmp((char*)payload, "START") == 0) { gameActive = true; totalScore = 0; }
    }
}

void setup() {
    Serial.begin(115200);
    
    // Dwing WiFi aan om een echt MAC adres te genereren
    WiFi.mode(WIFI_AP_STA); 
    delay(100);
    
    Serial.println("");
    Serial.print("JE MAC ADRES IS: ");
    Serial.println(WiFi.macAddress()); // DIT ADRES MOET IN JE SLAVE CODE

    WiFi.softAP(ssid, password);
    
    if (esp_now_init() != ESP_OK) return;
    esp_now_register_recv_cb(onDataRecv);
    
    server.on("/", HTTP_GET, [](AsyncWebServerRequest *request){
        request->send(200, "text/html", index_html);
    });

    server.begin();
    webSocket.begin();
    webSocket.onEvent(onWebSocketEvent);
}

void loop() {
    webSocket.loop();
}

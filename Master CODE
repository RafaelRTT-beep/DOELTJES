#include <WiFi.h>
#include <ESPAsyncWebServer.h>
#include <WebSocketsServer.h>
#include <esp_now.h>
#include <ArduinoJson.h>
#include <LittleFS.h>

// --- CONFIGURATIE ---
const char* ssid = "RTT_COMMAND_ELITE";
const char* password = "1234567"; 

AsyncWebServer server(80);
WebSocketsServer webSocket = WebSocketsServer(81);

enum GameMode { MANUAL, SEQUENCE, RANDOM, SHOOT_NO_SHOOT };
GameMode currentMode = MANUAL;
float top3[4][3]; 

int totalScore = 0;
bool gameActive = false;
bool gamePaused = false;
unsigned long startTime = 0;

typedef struct struct_message {
    int targetID;
    int command;
} struct_message;
struct_message rxData;

// --- GEHEUGEN FUNCTIES ---
void saveRecords() {
    File file = LittleFS.open("/records.bin", "w");
    if(file) {
        file.write((uint8_t*)top3, sizeof(top3));
        file.close();
    }
}

void loadRecords() {
    if(!LittleFS.begin(true)) return;
    if(LittleFS.exists("/records.bin")) {
        File file = LittleFS.open("/records.bin", "r");
        file.read((uint8_t*)top3, sizeof(top3));
        file.close();
    } else {
        for(int m=0; m<4; m++) for(int i=0; i<3; i++) top3[m][i] = 99.99;
    }
}

// --- WEB INTERFACE (NU EXTRA VEILIG GEFORMATTEERD) ---
const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE html><html><head><meta charset="UTF-8"><title>RTT HUB</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
body{background:#050505;color:#fff;font-family:'Orbitron',sans-serif;margin:0;display:grid;grid-template-columns:250px 1fr 300px;height:100vh;}
.menu{background:#0a0a0a;border-right:2px solid #f00;padding:20px;}
.btn{width:100%;background:#111;border:1px solid #444;color:#aaa;padding:15px;margin:5px 0;cursor:pointer;font-family:'Orbitron';}
.btn.active{border-color:#f00;color:#f00;background:rgba(255,0,0,0.1);}
#mainBtn{background:#900;color:#fff;border:none;font-weight:900;margin-top:20px;}
.hud{display:flex;flex-direction:column;justify-content:center;align-items:center;}
#score{font-size:12vw;color:#f00;text-shadow:0 0 20px #f00;line-height:1;}
#timer{font-size:5vw;color:#666;}
.side-r{background:#0a0a0a;border-left:2px solid #333;padding:20px;}
.rec{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #222;font-size:0.8em;}
</style></head>
<body>
<div class="menu">
<h3 style="color:#f00;font-size:0.7em;">SYSTEM_MODES</h3>
<button class="btn active" id="m0" onclick="setMode(0)">FREE_FIRE</button>
<button class="btn" id="m1" onclick="setMode(1)">SEQUENCE</button>
<button class="btn" id="m2" onclick="setMode(2)">RANDOM</button>
<button id="mainBtn" class="btn" onclick="toggleGame()">START_MISSION</button>
<button class="btn" onclick="ws.send('RESET')" style="font-size:0.6em;margin-top:50px;">RESET_SYSTEM</button>
</div>
<div class="hud">
<div id="score">00</div>
<div id="timer">00.00s</div>
</div>
<div class="side-r">
<h3 style="color:#f00;font-size:0.7em;">TOP_RECORDS</h3>
<div id="leaderboard">
<div class="rec" style="color:#ffd700;"><span>1.</span><span id="r0">--.--</span></div>
<div class="rec"><span>2.</span><span id="r1">--.--</span></div>
<div class="rec"><span>3.</span><span id="r2">--.--</span></div>
</div>
</div>
<script>
var ws = new WebSocket('ws://' + window.location.hostname + ':81/');
var t; var time = 0; var running = false;
ws.onmessage = function(e) {
var d = JSON.parse(e.data);
if(d.type === "HIT") document.getElementById('score').innerText = d.total.toString().padStart(2, '0');
if(d.type === "LEADERBOARD") {
document.getElementById('r0').innerText = d.t1.toFixed(2)+"s";
document.getElementById('r1').innerText = d.t2.toFixed(2)+"s";
document.getElementById('r2').innerText = d.t3.toFixed(2)+"s";
}
};
function toggleGame() {
if(!running) {
ws.send("START");
t = setInterval(() => { time += 0.01; document.getElementById('timer').innerText = time.toFixed(2) + "s"; }, 10);
document.getElementById('mainBtn').innerText = "PAUSE_MISSION";
running = true;
} else {
ws.send("PAUSE");
clearInterval(t);
document.getElementById('mainBtn').innerText = "RESUME_MISSION";
running = false;
}
}
function setMode(m) { 
ws.send("MODE:"+m); 
document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
document.getElementById('m'+m).classList.add('active');
}
</script></body></html>)rawliteral";

// --- EVENT HANDLERS ---
void onWebSocketEvent(uint8_t num, WStype_t type, uint8_t * payload, size_t length) {
    if (type == WStype_TEXT) {
        String msg = (char*)payload;
        if (msg == "START") { gameActive = true; gamePaused = false; startTime = millis(); totalScore = 0; }
        else if (msg == "PAUSE") { gamePaused = true; }
        else if (msg == "
